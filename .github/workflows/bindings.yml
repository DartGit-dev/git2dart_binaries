name: Generate bindings

on:
  push:
    # tags:
    # - "v[0-9]+.[0-9]+.[0-9]+*"
    branches:
      # - "main"
      - "**"
env:
  PUB_ENVIRONMENT: bot.github
  LIBGIT2_VERSION: "1.9.0"
  LIBSSH2_VERSION: "1.11.1"
  NDK_VERSION: "r26c"
  OPENSSL_VERSION: 3.2.0
jobs:

  # generate_bindings:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Check out repository
  #       uses: actions/checkout@v4

  #     - uses: actions/checkout@v4
  #       with:
  #         repository: libgit2/libgit2
  #         ref: refs/tags/v${{ env.LIBGIT2_VERSION }}
  #         path: ./libgit2
  #     - run: mv ./libgit2/include ./headers && rm -fR ./libgit2

  #     - name: Install libclang
  #       run: |
  #         sudo DEBIAN_FRONTEND=noninteractive apt-get update -o Acquire::Retries=3 && sudo DEBIAN_FRONTEND=noninteractive apt-get install  -o Acquire::Retries=3 -y --no-install-recommends libclang-dev
  #     - name: Run ffigen
  #       uses: subosito/flutter-action@v2
  #     - run:  flutter pub get
  #     - run:  rm headers/git2/deprecated.h
  #     - run:  dart run ffigen --config ffigen.yaml --ignore-source-errors
  #   # - run:  flutter test
  #     - name: Cache git2 library
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: cache-bindings
  #         path: lib/src/bindings.dart

   
  build_libgit2_android:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        abi: [armeabi-v7a]
        # abi: [armeabi-v7a, arm64-v8a, x86, x86_64]
        api: [21]


    steps:
  # --- Подготовка среды --------------------------------------------------
    - name: Checkout sources
      uses: actions/checkout@v4
      with:
        repository: libssh2/libssh2
        ref: refs/tags/libssh2-${{ env.LIBSSH2_VERSION }}

    - name: Install build deps (perl, make, etc.)
      run: sudo apt-get update && sudo apt-get install -y perl build-essential

    - name: Set up Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r26c
        add-to-path: true

    # --- Сборка OpenSSL ----------------------------------------------------
    - name: Build & install OpenSSL (${{ matrix.abi }})
      run: |
        mkdir -p openssl && cd openssl  

        # Set up Android NDK environment
        export ANDROID_NDK_ROOT=$ANDROID_NDK_HOME
        export PATH=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
        
        # Set up target-specific variables
        case "${{ matrix.abi }}" in
          arm64-v8a)
            TARGET=android-arm64
            ARCH=aarch64
            ANDROID_API=${{ matrix.api }}
            ;;
          armeabi-v7a)
            TARGET=android-arm
            ARCH=armv7a
            ANDROID_API=${{ matrix.api }}
            ;;
          x86)
            TARGET=android-x86
            ARCH=i686
            ANDROID_API=${{ matrix.api }}
            ;;
          x86_64)
            TARGET=android-x86_64
            ARCH=x86_64
            ANDROID_API=${{ matrix.api }}
            ;;
        esac

        # Download OpenSSL with verification
        curl -L -O https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz
        if [ ! -f openssl-${OPENSSL_VERSION}.tar.gz ]; then
          echo "Failed to download OpenSSL source"
          exit 1
        fi

        # Verify the archive
        if ! tar -tzf openssl-${OPENSSL_VERSION}.tar.gz > /dev/null; then
          echo "Invalid OpenSSL archive"
          exit 1
        fi

        # Extract with verbose output
        tar xzf openssl-${OPENSSL_VERSION}.tar.gz
        if [ ! -d openssl-${OPENSSL_VERSION} ]; then
          echo "Failed to extract OpenSSL source"
          exit 1
        fi

        cd openssl-${OPENSSL_VERSION}

        # Configure OpenSSL with proper cross-compilation settings
        export ANDROID_NDK_HOME=$ANDROID_NDK_ROOT
        export CROSS_SYSROOT=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/sysroot
        
        # Set compiler paths for NDK 27.2.12479018
        export CC=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/clang
        export CXX=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/clang++
        export AR=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
        export RANLIB=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ranlib
        export STRIP=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip

        # Set target-specific flags
        export CFLAGS="--target=$ARCH-linux-android$ANDROID_API -D__ANDROID_API__=$ANDROID_API --sysroot=$CROSS_SYSROOT"
        export LDFLAGS="--target=$ARCH-linux-android$ANDROID_API --sysroot=$CROSS_SYSROOT"

        # Verify compiler exists
        if [ ! -f "$CC" ]; then
          echo "Compiler not found: $CC"
          echo "Available compilers in $ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:"
          ls -la $ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin
          exit 1
        fi

        # Configure OpenSSL with clang-specific settings
        ./Configure $TARGET \
          no-shared \
          no-tests \
          no-comp \
          no-hw \
          no-engine \
          no-asm \
          --prefix=$PREFIX_ROOT/${{ matrix.abi }} \
          --cross-compile-prefix=$ARCH-linux-android- \
          -D__ANDROID_API__=$ANDROID_API \
          CC="$CC" \
          CXX="$CXX" \
          AR="$AR" \
          RANLIB="$RANLIB" \
          STRIP="$STRIP" \
          CFLAGS="$CFLAGS" \
          LDFLAGS="$LDFLAGS" \
          android-clang

        make -j$(nproc)
        make install_sw
        
    # --- Сборка libssh2 ----------------------------------------------------
    - name: Configure & build libssh2 (${{ matrix.abi }})
      run: |
        cmake -S libssh2 -B $BUILD_DIR/libssh2/${{ matrix.abi }} \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=${{ matrix.abi }} \
          -DANDROID_PLATFORM=android-${{ matrix.api }} \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_SHARED_LIBS=OFF \
          -DENABLE_ZLIB_COMPRESSION=ON \
          -DBUILD_EXAMPLES=OFF \
          -DBUILD_TESTING=OFF \
          -DLIBSSH2_WITH_OPENSSL=ON \
          -DOPENSSL_ROOT_DIR=$PREFIX_ROOT/${{ matrix.abi }} \
          -DOPENSSL_INCLUDE_DIR=$PREFIX_ROOT/${{ matrix.abi }}/include \
          -DOPENSSL_SSL_LIBRARY=$PREFIX_ROOT/${{ matrix.abi }}/lib/libssl.a \
          -DOPENSSL_CRYPTO_LIBRARY=$PREFIX_ROOT/${{ matrix.abi }}/lib/libcrypto.a

        cmake --build $BUILD_DIR/libssh2/${{ matrix.abi }} --config Release -j$(nproc)

    # --- Публикация артефактов --------------------------------------------
    - name: Upload artifact (libssh2 + OpenSSL ${{ matrix.abi }})
      uses: actions/upload-artifact@v4
      with:
        name: libssh2-openssl-${{ matrix.abi }}
        path: |
          $BUILD_DIR/libssh2/${{ matrix.abi }}/src/libssh2.a
          $PREFIX_ROOT/${{ matrix.abi }}/lib/libssl.a
          $PREFIX_ROOT/${{ matrix.abi }}/lib/libcrypto.a
          $PREFIX_ROOT/${{ matrix.abi }}/include



          
      # - name: Checkout sources
      #   uses: actions/checkout@v4
      #   with:
      #     repository: libssh2/libssh2
      #     ref: refs/tags/libssh2-${{ env.LIBSSH2_VERSION }}
      #     path: ./libssh2

      # - name: Set up Android NDK ${{ env.NDK_VERSION }}
      #   uses: nttld/setup-ndk@v1
      #   with:
      #     ndk-version: ${{ env.NDK_VERSION }}
      #     add-to-path: true

      #           # Конфигурация и сборка
      # - name: Configure & Build libssh2 (${{ matrix.abi }})
      #   run: |
      #     cd libssh2
      #     mkdir -p build/${{ matrix.abi }}
      #     cmake -S . -B build/${{ matrix.abi }} \
      #     -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
      #     -DANDROID_ABI=${{ matrix.abi }} \
      #     -DANDROID_PLATFORM=android-${{ matrix.api }} \
      #     -DBUILD_SHARED_LIBS=OFF \
      #     -DENABLE_ZLIB_COMPRESSION=ON \
      #     -DBUILD_EXAMPLES=OFF \
      #     -DBUILD_TESTING=OFF \
      #     -DCMAKE_BUILD_TYPE=Release
      #     cmake --build build/${{ matrix.abi }} --config Release -j$(nproc)

   
    # steps:
    #   - name: Run prerequistes
    #     run: |
    #       sudo DEBIAN_FRONTEND=noninteractive apt-get update -o Acquire::Retries=3 && sudo DEBIAN_FRONTEND=noninteractive apt-get install  -o Acquire::Retries=3 -y --no-install-recommends clang cmake curl libssl-dev
    #       mkdir /tmp/export

    #   - uses: actions/checkout@v4
    #     with:
    #       repository: libssh2/libssh2
    #       ref: refs/tags/libssh2-${{ env.LIBSSH2_VERSION }}
    #       path: ./libssh2
    #   - run: |
    #       mv ./libssh2 /tmp/libssh2 && cd /tmp/libssh2
    #       mkdir -p /usr/local/share/doc

    #       cmake -B bld -DCRYPTO_BACKEND=OpenSSL  -DCMAKE_INSTALL_PREFIX=/tmp/libssh2/install
    #       cmake --build bld --target install
    #       cp  /tmp/libssh2/install/lib/libssh2.so /tmp/export/libssh2.so
    #   - uses: actions/checkout@v4
    #     with:
    #       repository: libgit2/libgit2
    #       ref: refs/tags/v${{ env.LIBGIT2_VERSION }}
    #       path: ./libgit2
    #   - name: Build and test
    #     run: |
    #       mv ./libgit2 /tmp/libgit2
    #       cd /tmp/libgit2
    #       cmake -B bld -DUSE_SSH=libssh2 -DBUILD_TESTS=ON  -DEXPERIMENTAL_SHA256=ON -DCMAKE_INSTALL_PREFIX=/tmp/libgit2/install -DLIBSSH2_INCLUDE_DIR=/tmp/libssh2/install/include -DLIBSSH2_LIBRARY=/tmp/libssh2/install/lib/libssh2.so
    #       cmake --build bld --target install
    #       ./bld/libgit2_tests

    #   - name: Export git2 library
    #     run: |
    #       cp /tmp/libgit2/install/lib/libgit2-experimental.so /tmp/export/libgit2.so
    #   - name: Cache git2 library
    #     uses: actions/upload-artifact@v4
    #     with:
    #       name: cache-linux
    #       path: /tmp/export/**
